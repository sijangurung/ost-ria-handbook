# Python

This chapter serves as a guideline for writing and reviewing python code.

## Setting up your environment

You are recommended to use [pyenv][pyenv] with the
[pyenv-virtualenv][pyenv-virtualenv] plugin.

#### TLDR to get started;

To install pyenv  and pyenv-virtualenv on macOS, run:

```sh
brew install pyenv pyenv-virtualenv
```

To activate pyenv this add to your shell profile (`~./bash_profile` or
similar):

```sh
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"
```

To install a python version and create a virtualenv for the repository, run:

```sh
pyenv install 3.6.5 # Use the correct version for the repository
pyenv virtualenv 3.6.5 my-repository-3.6.5
```

To automatically activate the correct virtualenv in the repository, run:

```sh
echo "my-repository-3.6.5" ./my-respository/.python-version
```

## Tools

These are our common tools to help us develop python applications.

* [flake8][flake8]
* [make][make]
* [pytest][pytest]

## Style Guide

### PEP 20 -- The Zen of Python

> Long time Pythoneer Tim Peters succinctly channels the BDFL's guiding
> principles for Python's design into 20 aphorisms, only 19 of which have been
> written down.
>
> Source: [PEP 20][pep-0020]

[PEP 20 -- The Zen of Python][pep-0020] serves as a starting point for writing
readable and maintainable pythonic code.

### PEP 8 -- Style Guide for Python Code

[PEP 8 -- Style Guide for Python Code][pep-0008] is our style guide that
dictates the details for how our python code should be written. To help govern
these rules in our codebase we use a tool to [lint][lint] our code. The default
tool is [flake8][flake8], but other tools are available.

Where [PEP 8][pep-0008] allows for choice on how to write the code, our
decisions will be documented here.

#### String Quotes

> In Python, single-quoted strings and double-quoted strings are the same. This
> PEP does not make a recommendation for this. Pick a rule and stick to it.
> When a string contains single or double quote characters, however, use the
> other one to avoid backslashes in the string. It improves readability.
>
> For triple-quoted strings, always use double quote characters to be
> consistent with the docstring convention in [PEP 257][pep-0257].
>
> Source: [PEP 8][pep-0008-string-quotes]

RIA recommends single-quoted strings.

#### Import formatting

Imports must be on separate lines.

##### Example

```python
import os
import sys
```

#### Import Order

Imports are always put at the top of the file, just after any module comments
and doc strings and before module globals and constants. Imports should be
grouped with the order from most generic to least generic:

* Standard library imports
* Third-party imports
* Application-specific imports

Each group is sorted using these rules:

* `import foo` comes before `from foo import bar`
* Imports are sorted lexicographically, ignoring case, according to each
  module's full package path.

##### Example

```python
import logging
import sys
from collections import OrderedDict

import third_party
from third_party import bar
from third_party.bar import baz
from third_party.bar import Quux

import application
from application import bar
from application.bar import baz
from application.bar import Quux
```

## Test Coverage

All Python code used in other modules must have full test coverage. Ideally all
of the code should have full test coverage and all modules, classes, methods
and functions should have their own unit tests.

Code intentionally left untested must be excluded from the tests using the test
frameworks annotations.

## Artifacts

Most of our Python applications generate 2 artifacts during build, a Python
Wheel that install a command and a Docker image. The python wheel is installed
in the Docker image and the command installed by the python wheel is set as the
`ENTRYPOINT` of the Docker image.

## Codebase setup

Here are the standard files needed to start a new python codebase.

* [`.dockerignore`](#dockerignore)
* [`.editorconfig`](#editorconfig)
* [`.gitignore`](#gitignore)
* [`README.md`](#readmemd)
* [`Dockerfile`](#dockerfile)
* [`Makefile`](#makefile)
* [`setup.cfg`](#setupcfg)
* [`setup.py`](#setuppy)

### .dockerignore

```conf
.git
build
dist
```

### .editorconfig

This is our default [EditorConfig][editorconfig] setup.

```ini
root = true

[*]
charset = utf-8
end_of_line = lf
indent_size = 4
indent_style = space
insert_final_newline = false
max_line_length = 79
trim_trailing_whitespace = true

# YAML
[*.{yml,yaml}]
indent_size = 2

# JSON
[*.json]
indent_size = 2

[Makefile]
indent_style = tab
```

### .gitignore

A good starting point for a `.gitignore` file can be generated by running:

```sh
curl -L -s https://www.gitignore.io/api/vim,linux,emacs,macos,python,windows,intellij+all > .gitignore
```

Then add this entry to the bottom of the `.gitignore` file.

```conf
# Pytest
.pytest_cache

# Pyenv
.python-version
```


### README.md

    # Application name

    Application name generates new features in DDI.  Nullam fermentum massa
    libero, ac venenatis velit egestas vitae. Vestibulum quis hendrerit urna,
    nec maximus massa. Integer eleifend finibus sapien posuere faucibus. Proin
    posuere, nisi vitae bibendum sollicitudin, ipsum dolor accumsan sem, id
    eleifend mauris lectus vehicula leo. Cras id cursus enim. Nullam ut leo
    consectetur, tempor metus ac, auctor tortor. Vivamus lobortis vulputate
    risus vitae faucibus. Suspendisse feugiat libero sit amet tortor
    condimentum auctor. Pellentesque erat lorem, elementum dignissim est at,
    hendrerit gravida velit. Sed tristique id libero id imperdiet. Vestibulum
    lacus ligula, faucibus sed scelerisque a, consequat ac urna. Curabitur nibh
    tellus, faucibus quis est ut, suscipit auctor metus. Fusce volutpat
    bibendum purus, nec mattis nibh ullamcorper sit amet. Quisque cursus
    tincidunt lacus, ut ullamcorper arcu malesuada et. Morbi feugiat
    sollicitudin mauris vel maximus. Ut rutrum, quam eget tempor interdum,
    sapien diam dignissim nibh, ac semper tellus mauris ac mi.

    ## Prerequisite

    * Configure your editor to use [EditorConfig][editorconfig]
    * Python 3.6.x
    * Virtual environment configured for this project

    ### Tips

    Easy way on mac os to get a python virtual environment.

    Install [pyenv][pyenv] and [pyenv-virtualenv][pyenv-virtualenv]

    ## Develop

    Configure a python 3.6.x virtual envrironment and activate it then run:

    ```sh
    make configure
    ```

    Start the service with:

    ```sh
    application-name -h
    ```

    ### Lint

    ```sh
    make lint
    ```

    ### Test

    ```sh
    make test
    ```

    ### Build

    #### Python Wheel

    ```sh
    make wheel
    ```

    #### Docker image

    ```sh
    make docker
    ```

    ## References

    * AWS SDK: [Boto 3][boto3]
    * CLI library: [docopt][docopt]
    * Test tool: [pytest][pytest], [pytest-cov][pytest-cov], [pytest-flask][pytest-flask]
    * Code style guide tool: [flake8][flake8]

    [boto3]: https://boto3.readthedocs.io
    [docopt]: http://docopt.org
    [editorconfig]: http://editorconfig.org
    [flake8]: http://flake8.pycqa.org/
    [pyenv-virtualenv]: https://github.com/pyenv/pyenv-virtualenv
    [pyenv]: https://github.com/pyenv/pyenv
    [pytest-cov]: https://pytest-cov.readthedocs.io
    [pytest]: https://docs.pytest.org`

### Dockerfile

This is an example `Dockerfile` that builds the Python application wheel and
installs the application into a runtime image. The command installed by the
Python wheel is set as the `ENTRYPOINT`. For more information see the
[Docker][chapter-docker] chapter.

```dockerfile
FROM python:3.6-alpine as builder

RUN apk add --update \
   make

# Add the code
ADD . /app

# Build the codebase, will run tests etc
WORKDIR /app
RUN make build

FROM python:3.6-alpine

# Copy the runtime artifact from the builder image
COPY --from=builder /app/dist /dist

# Install the runtime artifact
RUN pip install dist/application_name-0.0.1-py3-none-any.whl
RUN rm -rf dist

ENTRYPOINT [ "application_name" ]
```

### Makefile

We drive our development workflow using a [Makefile][chapter-make]. Here is
an example of the default targets we use for python code. This allows use to
choose the tools used for build, linting, testing etc without changing how
humans and CI interact with the development workflow. For more information see
the [Make][chapter-make] chapter.

```make
IMAGE = docker-image-name
TAG = latest

build: clean configure lint test
	python3 setup.py bdist_wheel

clean:
	find . -name '__pycache__' -exec rm -rf {} +
	find . -name '*.pyc' -exec rm -f {} +
	find . -name '*.pyo' -exec rm -f {} +
	find . -name '*~' -exec rm -f {} +
	rm -rf build/
	rm -rf dist/
	rm -rf *.egg-info

configure:
	pip install -e ".[dev]"

lint:
	flake8

test:
	pytest \
		--cov=application_name \
		--cov-report html \
		--cov-report term-missing \
		tests/

integration-test:
	pytest integration_tests

docker:
	docker build -t $(IMAGE):$(TAG) -f Dockerfile .
	echo "$(IMAGE):$(TAG)"

.PHONY: build clean configure lint test integration-test docker
```

### setup.cfg

```ini
[flake8]
exclude = .git,build,dist
max-line-length = 79
import-order-style = smarkets
application-import-names = aptilo_wifi
```

### setup.py

> Setuptools is a collection of enhancements to the Python distutils that allow
> developers to more easily build and distribute Python packages, especially
> ones that have dependencies on other packages.
>
> Source: [Setuptools][setuptools]

This is an example of a baseline `setup.py` used by our projects.

```python
from setuptools import setup, find_packages
from codecs import open
from os import path

here = path.abspath(path.dirname(__file__))

with open(path.join(here, 'README.md'), encoding='utf-8') as f:
    long_description = f.read()

setup(
    name='application_name',

    version='0.0.1',

    description='Short description',
    long_description=long_description,

    url='https://github.com/TeliaSoneraNorge/...',

    author='Telia Division X',

    license='CLOSED',

    classifiers=[
        'Development Status :: 3 - Alpha',
        'License :: OSI Approved :: Closed License',
        'Programming Language :: Python :: 3.6',
    ],

    keywords='',

    packages=find_packages(exclude=[
        'contrib',
        'docs',
        '*.tests',
        '*.tests.*',
        'tests.*',
        'tests',
        'integration_tests',
        'integration_tests.*'
        ]),

    # List of dependencies, with exact versions
    install_requires=[],

    # List additional groups of dependencies here (e.g. development
    # dependencies). You can install these using the following syntax,
    # for example:
    # $ pip install -e .[dev,test]
    extras_require={
        'dev': [
            'flake8',
            'flake8-import-order',
            'pytest',
            'pytest-cov',
            'wheel'
        ]
    },

    include_package_data=True,
    package_data={},

    entry_points={
        'console_scripts': [
            'application-name=application_name.__main__:main',
        ],
    },
)
```

[chapter-docker]: ./docker.md
[chapter-make]: ./make.md
[editorconfig]: http://editorconfig.org/
[flake8]: http://flake8.pycqa.org/en/latest/
[lint]: https://en.wikipedia.org/wiki/Lint_(software)
[make]: https://www.gnu.org/software/make/
[pep-0008-string-quotes]: https://www.python.org/dev/peps/pep-0008/#string-quotes
[pep-0008]: https://www.python.org/dev/peps/pep-0008/
[pep-0020]: https://www.python.org/dev/peps/pep-0020/
[pep-0257]: https://www.python.org/dev/peps/pep-0257/
[pytest]: https://docs.pytest.org/en/latest/
[setuptools]: https://setuptools.readthedocs.io/en/latest/setuptools.html
